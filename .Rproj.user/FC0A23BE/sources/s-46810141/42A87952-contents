library(testthat)
library(testUBSAN)
context("rcpp_use_after_free")
library(RcppDeepState)


user.display <- user_error_display("use_after_free_log")
test_that("valgrind use after free check", {
  expect_match(user.display$arg.name,"size_free")
  expect_match(user.display$src.file.lines,"use_after_free.cpp")
  expect_match(user.display$error.message[1],"Invalid read of size 4")
})

test_that("use after free return value",{
  return_value = testUBSAN::rcpp_use_after_deallocate(100)
  expect_gt(return_value,0)
})